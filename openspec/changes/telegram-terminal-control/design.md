## Context

用户希望通过 Telegram Bot 远程监控和控制本地计算机上运行的终端会话（特别是 Claude Code）。当前没有现成的解决方案能够：
1. 实时捕获终端输出并推送到移动设备
2. 允许从移动设备发送输入到终端
3. 管理多个终端会话

本项目是一个全新的 Python 应用，需要从零开始构建。

## Goals / Non-Goals

**Goals:**
- 通过 Telegram Bot 实时查看终端输出
- 通过 Telegram 发送文本输入到终端
- 支持 tmux 会话的连接和管理
- 简单的用户认证（限制授权用户）
- 输出智能截断，避免消息过长

**Non-Goals:**
- 不支持图形界面/GUI 应用
- 不实现完整的终端模拟器（如颜色、光标定位）
- 不支持多用户同时控制同一会话
- 不实现端到端加密（依赖 Telegram 自身加密）

## Decisions

### 1. 使用 Python + python-telegram-bot 库

**选择**: python-telegram-bot (异步版本)

**理由**:
- 成熟稳定，文档完善
- 原生支持 asyncio，便于处理并发
- 活跃维护

**备选方案**:
- Telethon: 功能更强但复杂度高
- aiogram: 也不错，但社区较小

### 2. 终端捕获方案：libtmux

**选择**: 通过 libtmux 连接现有 tmux 会话

**理由**:
- tmux 是成熟的终端复用器，用户可能已在使用
- libtmux 提供 Python API 读取 pane 内容和发送按键
- 不需要修改目标程序（如 Claude Code）

**备选方案**:
- PTY (伪终端): 需要启动新进程，无法连接现有会话
- script 命令: 只能记录，无法交互

### 3. 架构模式：单进程异步

**选择**: 单个 Python 进程，使用 asyncio 事件循环

**组件**:
```
┌─────────────────────────────────────────────────────┐
│                    Main Process                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │ TelegramBot │  │TermCapture  │  │SessionBridge│  │
│  │  Handler    │◄─┤  (libtmux)  │◄─┤   Manager   │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  │
└─────────────────────────────────────────────────────┘
         │                                    │
         ▼                                    ▼
   Telegram API                         tmux sessions
```

**理由**:
- 简单，易于部署和调试
- asyncio 足以处理 I/O 密集型任务

### 4. 输出推送策略：轮询 + 差异检测

**选择**: 定期轮询 tmux pane 内容，检测变化后推送

**参数**:
- 轮询间隔: 1-2 秒
- 只推送新增内容（差异）
- 消息长度限制: 4000 字符（Telegram 限制）

**理由**:
- libtmux 不支持事件订阅，轮询是唯一方案
- 差异检测避免重复推送

### 5. 用户认证：白名单 + 配置文件

**选择**: 在配置文件中指定授权的 Telegram user ID

**理由**:
- 简单有效
- 避免未授权用户控制终端

## Risks / Trade-offs

| 风险 | 缓解措施 |
|------|----------|
| 轮询延迟导致输出不及时 | 可调整轮询间隔，1秒通常足够 |
| 长输出导致消息刷屏 | 实现智能截断，只发送最新部分 |
| Telegram API 限流 | 合并短时间内的多次输出 |
| tmux 会话不存在 | 提供清晰的错误提示和会话列表 |
| 网络问题导致消息丢失 | Telegram 有重试机制，可接受 |
| Bot Token 泄露 | 使用环境变量或 .env 文件，不提交到代码库 |
